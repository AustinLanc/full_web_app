<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Chat</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; margin-bottom: 10px; }
    #inputArea { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Test Chat (Shared Account)</h2>

  <label for="nameSelect">Choose name:</label>
  <select id="nameSelect"></select>
  <input type="text" id="newName" placeholder="Or enter new name" />
  <button id="setName">Use Name</button>

  <div id="messages"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button id="send">Send</button>
  </div>

  <script>
    const socket = io('http://localhost:3000'); // Update if using a different port
    const sharedUserId = 1; // Replace with your shared account's user ID

    let currentName = '';
    let room = 'general';

    const nameSelect = document.getElementById('nameSelect');
    const newNameInput = document.getElementById('newName');
    const setNameBtn = document.getElementById('setName');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('send');

    // Load known names for the shared account
    async function loadNames() {
      const res = await fetch(`/users/${sharedUserId}/names`);
      const names = await res.json();
      nameSelect.innerHTML = names.map(n => `<option value="${n.name}">${n.name}</option>`).join('');
    }

    // Set current name (dropdown or new input)
    setNameBtn.onclick = async () => {
      const newName = newNameInput.value.trim();
      currentName = newName || nameSelect.value;

      if (newName) {
        // Add to backend
        await fetch(`/users/${sharedUserId}/names`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });
        await loadNames();
        nameSelect.value = newName;
        newNameInput.value = '';
      }

      alert(`Using name: ${currentName}`);
    };

    // Send message
    sendBtn.onclick = () => {
      const message = messageInput.value.trim();
      if (!message || !currentName) return;

      socket.emit('send_message', {
        room,
        message,
        sender_id: sharedUserId,
        display_name: currentName
      });

      messageInput.value = '';
    };

    // Receive message
    socket.on('receive_message', ({ message, sender_id, display_name, timestamp }) => {
      const ts = timestamp ? new Date(timestamp).toLocaleTimeString() : '';
      const msgEl = document.createElement('div');
      msgEl.textContent = `[${ts}] ${display_name}: ${message}`;
      messagesDiv.appendChild(msgEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Load history on connect
    socket.on('connect', () => {
      socket.emit('join_room', room);
      socket.emit('get_history', room, (messages) => {
        messagesDiv.innerHTML = '';
        messages.forEach(({ message, sender, display_name, timestamp }) => {
          const ts = new Date(timestamp).toLocaleTimeString();
          const msgEl = document.createElement('div');
          msgEl.textContent = `[${ts}] ${display_name || sender}: ${message}`;
          messagesDiv.appendChild(msgEl);
        });
      });
    });

    loadNames();
  </script>
</body>
</html>
